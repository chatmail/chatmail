name: deploy on staging.testrun.org, and if that works, on nine.testrun.org

on:
  push:
    branches:
      - main
      - staging-ci

jobs:
  deploy:
    name: deploy on staging.testrun.org, and if that works, on nine.testrun.org
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: stash TLS cert before rebuilding
        run: |
          mkdir ~/.ssh
          echo "${{ secrets.STAGING_SSH_KEY }}" >> ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan staging.testrun.org > ~/.ssh/known_hosts
          rsync -avz root@staging.testrun.org:/var/lib/acme . || true

      - name: rebuild staging.testrun.org to have a clean VPS
        run: |
            curl -X POST \
            -H "Authorization: Bearer ${{ secrets.HETZNER_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"image":"debian-12"}' \
            "https://api.hetzner.cloud/v1/servers/${{ secrets.STAGING_SERVER_ID }}/actions/rebuild"

      - name: initenv 
        run: scripts/initenv.sh

      - name: append venv/bin to PATH
        run: echo venv/bin >>$GITHUB_PATH

      - name: run formatting checks 
        run: cmdeploy fmt -v 

      - name: run deploy-chatmail offline tests 
        run: pytest --pyargs cmdeploy 

      - name: upload TLS cert after rebuilding
        run: |
          echo " --- wait until staging.testrun.org VPS is rebuilt --- "
          rm ~/.ssh/known_hosts
          while ! ssh -o ConnectTimeout=180 -o StrictHostKeyChecking=accept-new -v root@staging.testrun.org id -u ; do sleep 1 ; done
          ssh -o StrictHostKeyChecking=accept-new -v root@staging.testrun.org id -u
          rsync -avz acme root@staging.testrun.org:/var/lib/ || true

      - name: cmdeploy init staging.testrun.org
        run: cmdeploy init staging.testrun.org

      - name: cmdeploy run
        run: cmdeploy run

      - name: cmdeploy dns
        run: |
          echo "${{ secrets.DEFAULT_DNS_ZONE }}" > staging.testrun.org.zone
          cmdeploy dns --zonefile staging-additional.zone
          cat staging-additional.zone >> staging.testrun.org.zone
          scp -o StrictHostKeyChecking=accept-new staging.testrun.org.zone root@ns.testrun.org:/etc/nsd/staging.testrun.org.zone
          ssh root@ns.testrun.org nsd-checkzone staging.testrun.org /etc/nsd/staging.testrun.org.zone
          ssh root@ns.testrun.org systemctl reload nsd
          cmdeploy dns || cmdeploy dns || cmdeploy dns

      - name: cmdeploy test
        run: CHATMAIL_DOMAIN2=nine.testrun.org cmdeploy test --slow

